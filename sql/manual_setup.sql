-- u0421u043au0440u0438u043fu0442 u0434u043bu044f u0440u0443u0447u043du043eu0439 u043du0430u0441u0442u0440u043eu0439u043au0438 u0431u0430u0437u044b u0434u0430u043du043du044bu0445 Supabase
-- u0412u044bu043fu043eu043bu043du0438u0442u044c u044du0442u043eu0442 u0441u043au0440u0438u043fu0442 u0432 SQL-u0440u0435u0434u0430u043au0442u043eu0440u0435 Supabase

-- u0423u0434u0430u043bu044fu0435u043c u0441u0443u0449u0435u0441u0442u0432u0443u044eu0449u0438u0435 u0442u0430u0431u043bu0438u0446u044b
DROP TABLE IF EXISTS daily_checkins CASCADE;
DROP TABLE IF EXISTS checkins CASCADE;
DROP TABLE IF EXISTS referrals CASCADE;
DROP TABLE IF EXISTS users CASCADE;

-- u0421u043eu0437u0434u0430u0435u043c u0442u0430u0431u043bu0438u0446u0443 u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu0435u0439
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    telegram_id TEXT NOT NULL UNIQUE,
    username TEXT,
    first_name TEXT,
    last_name TEXT,
    points INTEGER DEFAULT 0,
    referral_code TEXT UNIQUE,
    referred_by BIGINT REFERENCES users(id),
    current_streak INTEGER DEFAULT 0,
    max_streak INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW()),
    last_checkin TIMESTAMP WITH TIME ZONE
);

-- u0421u043eu0437u0434u0430u0435u043c u0442u0430u0431u043bu0438u0446u0443 u0434u043bu044f u0447u0435u043au0438u043du043eu0432
CREATE TABLE checkins (
    id BIGSERIAL PRIMARY KEY,
    user_id TEXT NOT NULL, -- u0418u0441u043fu043eu043bu044cu0437u0443u0435u043c telegram_id u0432u043cu0435u0441u0442u043e u0441u0441u044bu043bu043au0438 u043du0430 id
    streak_count INTEGER NOT NULL,
    xp_earned INTEGER NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW())
);

-- u0421u043eu0437u0434u0430u0435u043c u0442u0430u0431u043bu0438u0446u0443 u0434u043bu044f u0440u0435u0444u0435u0440u0430u043bu043eu0432
CREATE TABLE referrals (
    id BIGSERIAL PRIMARY KEY,
    referrer_id TEXT NOT NULL, -- Telegram ID u0440u0435u0444u0435u0440u0435u0440u0430
    referred_id TEXT NOT NULL, -- Telegram ID u043fu0440u0438u0433u043bu0430u0448u0435u043du043du043eu0433u043e u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW())
);

-- u0421u043eu0437u0434u0430u0435u043c u0445u0440u0430u043du0438u043cu0443u044e u043fu0440u043eu0446u0435u0434u0443u0440u0443 u0434u043bu044f u0443u0432u0435u043bu0438u0447u0435u043du0438u044f XP u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f
CREATE OR REPLACE FUNCTION increment_xp(user_id TEXT, xp_amount INTEGER)
RETURNS VOID AS $$
BEGIN
  -- u041eu0431u043du043eu0432u043bu044fu0435u043c u043au043eu043bu0438u0447u0435u0441u0442u0432u043e XP u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f
  UPDATE users
  SET points = COALESCE(points, 0) + xp_amount
  WHERE telegram_id = user_id;
  
  -- u0415u0441u043bu0438 u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044c u043du0435 u043du0430u0439u0434u0435u043d, u0441u043eu0437u0434u0430u0435u043c u043du043eu0432u043eu0433u043e
  IF NOT FOUND THEN
    INSERT INTO users (telegram_id, points)
    VALUES (user_id, xp_amount);
  END IF;
END;
$$ LANGUAGE plpgsql;

-- u0414u043eu0431u0430u0432u043bu044fu0435u043c u043fu043eu043bu044cu0438u0442u0438u043au0438 RLS u0434u043bu044f u0442u0430u0431u043bu0438u0446

-- u0412u043au043bu044fu0437u0438u043c RLS u0434u043bu044f u0442u0430u0431u043bu0438u0446 u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044a
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- u0414u043eu0431u0430u0432u043bu044fu0435u043c u043fu043eu043bu044cu0438u0442u0438u043au0438 u0434u043bu044f u0447u0442u0435u043du0438u044f u0434u0430u043du043du044bu0445 u0438u0437 u0442u0430u0431u043bu0438u0446 u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044a
CREATE POLICY users_select_policy ON users
    FOR SELECT
    USING (true);

-- u0414u043eu0431u0430u0432u043bu044fu0435u043c u043fu043eu043bu044cu0438u0442u0438u043au0438 u0434u043bu044f u0432u0441u0442u0430u0432u043au0438 u0434u0430u043du043du044bu0445 u0432 u0442u0430u0431u043bu0438u0446 u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044a
CREATE POLICY users_insert_policy ON users
    FOR INSERT
    WITH CHECK (true);

-- u0414u043eu0431u0430u0432u043bu044fu0435u043c u043fu043eu043bu044cu0438u0442u0438u043au0438 u0434u043bu044f u043eu0431u043du043eu0432u043bu0435u043du0438u044f u0434u0430u043du043du044bu0445 u0432 u0442u0430u0431u043bu0438u0446 u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044a
CREATE POLICY users_update_policy ON users
    FOR UPDATE
    USING (true);

-- u0412u043au043bu044fu0437u0438u043c RLS u0434u043bu044f u0442u0430u0431u043bu0438u0446 u0434u043bu044f u0447u0435u043au0438u043du043eu0432
ALTER TABLE checkins ENABLE ROW LEVEL SECURITY;

-- u0414u043eu0431u0430u0432u043bu044fu0435u043c u043fu043eu043bu044cu0438u0442u0438u043au0438 u0434u043bu044f u0447u0442u0435u043du0438u044f u0434u0430u043du043du044bu0445 u0438u0437 u0442u0430u0431u043bu0438u0446 u0434u043bu044f u0447u0435u043au0438u043du043eu0432
CREATE POLICY checkins_select_policy ON checkins
    FOR SELECT
    USING (true);

-- u0414u043eu0431u0430u0432u043bu044fu0435u043c u043fu043eu043bu044cu0438u0442u0438u043au0438 u0434u043bu044f u0432u0441u0442u0430u0432u043au0438 u0434u0430u043du043du044bu0445 u0432 u0442u0430u0431u043bu0438u0446 u0434u043bu044f u0447u0435u043au0438u043du043eu0432
CREATE POLICY checkins_insert_policy ON checkins
    FOR INSERT
    WITH CHECK (true);

-- u0412u043au043bu044fu0437u0438u043c RLS u0434u043bu044f u0442u0430u0431u043bu0438u0446 u0434u043bu044f u0440u0435u0444u0435u0440u0430u043bu043eu0432
ALTER TABLE referrals ENABLE ROW LEVEL SECURITY;

-- u0414u043eu0431u0430u0432u043bu044fu0435u043c u043fu043eu043bu044cu0438u0442u0438u043au0438 u0434u043bu044f u0447u0442u0435u043du0438u044f u0434u0430u043du043du044bu0445 u0438u0437 u0442u0430u0431u043bu0438u0446 u0434u043bu044f u0440u0435u0444u0435u0440u0430u043bu043eu0432
CREATE POLICY referrals_select_policy ON referrals
    FOR SELECT
    USING (true);

-- u0414u043eu0431u0430u0432u043bu044fu0435u043c u043fu043eu043bu044cu0438u0442u0438u043au0438 u0434u043bu044f u0432u0441u0442u0430u0432u043au0438 u0434u0430u043du043du044bu0445 u0432 u0442u0430u0431u043bu0438u0446 u0434u043bu044f u0440u0435u0444u0435u0440u0430u043bu043eu0432
CREATE POLICY referrals_insert_policy ON referrals
    FOR INSERT
    WITH CHECK (true);
