<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>XGO Mini App</title>
  <style>
    :root {
      --tg-theme-bg-color: #000;
      --tg-theme-text-color: #fff;
      --tg-theme-accent-color: #ff3c3c;
    }

    @font-face {
      font-family: 'Brinnan';
      src: url('Brinnan-Bold.otf') format('opentype');
      font-weight: bold;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: 'Brinnan', monospace;
      background-color: var(--tg-theme-bg-color, #000);
      color: var(--tg-theme-text-color, #fff);
    }

    .background-video {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      z-index: 0;
      display: none;
    }
    .background-video.active {
      display: block;
    }

    .screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 1;
    }
    .screen.active {
      display: flex !important;
    }

    .btn {
      padding: 12px 28px;
      font-size: 20px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-family: 'Brinnan', monospace;
      background: var(--tg-theme-bg-color, #000);
      border: 2px solid var(--tg-theme-accent-color, #ff3c3c);
      box-shadow: 0 0 4px var(--tg-theme-accent-color, #ff3c3c), 0 0 8px var(--tg-theme-accent-color, #ff3c3c);
      transition: all 0.2s ease-in-out;
      color: var(--tg-theme-text-color, #fff);
    }
    .btn-checkin { color: #fff; }
    .btn-referral { color: var(--tg-theme-accent-color, #ff3c3c); }

    .btn:hover {
      transform: scale(1.05);
    }

    .button-group {
      display: flex;
      gap: 40px;
      margin-top: 20px;
    }

    .button-container {
      position: absolute;
      bottom: 9%;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }

    .label {
      font-size: 36px;
      font-weight: bold;
      color: var(--tg-theme-text-color, #fff);
      text-shadow: 1px 1px 0 var(--tg-theme-accent-color, #ff3c3c), -1px -1px 0 var(--tg-theme-accent-color, #ff3c3c), 2px 2px 10px var(--tg-theme-accent-color, #ff3c3c);
      margin-top: 54vh;
    }

    .days {
      font-size: 60px;
      font-weight: bold;
      color: var(--tg-theme-accent-color, #ff3c3c);
      text-shadow: 0 0 2px #ffffff, 0 0 4px #ffffff, 0 0 6px #ffffff;
      margin-top: 10px;
    }

    .ref-link {
      background: rgba(255,60,60,0.15);
      padding: 10px 12px;
      border-radius: 8px;
      word-break: break-all;
      color: var(--tg-theme-accent-color, #ff3c3c);
      margin: 10px 0 10px 0;
      font-size: 15px;
      text-align: center;
      user-select: all;
    }
    .info {
      color: var(--tg-theme-text-color, #fff);
      font-size: 24px;
      margin-top: 40vh;
      text-align: center;
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <!-- Videos -->
  <video muted loop playsinline autoplay class="background-video active" id="start-bg">
    <source src="стиль1.mp4" type="video/mp4" />
  </video>
  <video muted loop playsinline class="background-video" id="checkin-bg">
    <source src="chek-in.mp4" type="video/mp4" />
  </video>
  <video muted loop playsinline class="background-video" id="referral-bg">
    <source src="referral.mp4" type="video/mp4" />
  </video>

  <!-- Screens -->
  <div class="screen active" id="start-screen">
    <div class="button-container" id="start-btns">
      <button class="btn btn-checkin" id="checkin-btn">CHECK IN</button>
      <button class="btn btn-referral" id="referral-btn">REFERRAL</button>
    </div>
  </div>

  <div class="screen" id="checkin-screen">
    <div class="label">ACTIVE DAYS</div>
    <div class="days" id="streak">0</div>
    <div class="button-group">
      <button class="btn btn-checkin" id="xp-btn">+10 XP</button>
      <button class="btn btn-checkin" id="xgo-btn">+5 XGO</button>
    </div>
    <button class="btn btn-referral" style="margin-top: 40px;" id="back-from-checkin">⬅ Назад</button>
  </div>

  <div class="screen" id="referral-screen">
    <div class="info" id="referral-info">Загрузка...</div>
    <button class="btn btn-referral" style="margin-top: 20px;" id="back-from-referral">⬅ Назад</button>
  </div>

<script>
const tg = window.Telegram.WebApp;

// --- Theme adaptation ---
function applyTheme() {
  if (!tg.themeParams) return;
  const params = tg.themeParams;
  if (params.bg_color) document.documentElement.style.setProperty('--tg-theme-bg-color', params.bg_color);
  if (params.text_color) document.documentElement.style.setProperty('--tg-theme-text-color', params.text_color);
  if (params.accent_text_color) document.documentElement.style.setProperty('--tg-theme-accent-color', params.accent_text_color);
}
applyTheme();

// --- Video switching ---
function showBg(bgId) {
  ['start-bg', 'checkin-bg', 'referral-bg'].forEach(id => {
    const v = document.getElementById(id);
    v.classList.toggle('active', id === bgId);
    if (id === bgId) {
      v.currentTime = 0;
      v.play().catch(()=>{});
    } else {
      v.pause();
    }
  });
}

// --- Screen switching ---
function showScreen(screenId) {
  ['start-screen', 'checkin-screen', 'referral-screen'].forEach(id => {
    document.getElementById(id).classList.toggle('active', id === screenId);
  });
}

// --- User data (localStorage for demo) ---
let userData = {
  streak: 0,
  lastCheckIn: null,
  xp: 0,
  xgo: 0
};
function loadUserData() {
  const saved = localStorage.getItem('xgo_user_data');
  if (saved) userData = JSON.parse(saved);
}
function saveUserData() {
  localStorage.setItem('xgo_user_data', JSON.stringify(userData));
}
function updateStreakDisplay() {
  document.getElementById('streak').innerText = userData.streak;
}
function canCheckIn() {
  if (!userData.lastCheckIn) return true;
  const last = new Date(userData.lastCheckIn);
  const now = new Date();
  return (now - last) / (1000 * 60 * 60) >= 24;
}

// --- Check-in logic ---
function performCheckIn(type) {
  if (!canCheckIn()) {
    tg.showPopup ? tg.showPopup({title: 'Ошибка', message: 'Сегодня вы уже чекинились!'}) : alert('Сегодня вы уже чекинились!');
    return;
  }
  userData.streak += 1;
  userData.lastCheckIn = new Date().toISOString();
  if (type === 'xp') userData.xp += 10;
  if (type === 'xgo') userData.xgo += 5;
  updateStreakDisplay();
  saveUserData();
  if (tg.sendData) tg.sendData(JSON.stringify({action: 'check_in', reward: type, amount: type === 'xp' ? 10 : 5}));
  tg.showPopup ? tg.showPopup({title: 'Успех', message: `Вы получили +${type === 'xp' ? 10 : 5} ${type.toUpperCase()}!`}) : alert(`Вы получили +${type === 'xp' ? 10 : 5} ${type.toUpperCase()}!`);
}

// --- Referral logic ---
function getReferralLink() {
  const user = tg.initDataUnsafe?.user;
  if (!user) return null;
  // Замените на имя вашего бота
  const botname = 'your_bot_username';
  const code = user.id + '_' + Date.now();
  return `https://t.me/${botname}?start=${code}`;
}
function showReferralInfo() {
  const info = document.getElementById('referral-info');
  const link = getReferralLink();
  if (!link) {
    info.innerHTML = 'Не удалось получить данные пользователя Telegram.';
    return;
  }
  info.innerHTML = `
    <div>Пригласи друзей и получи бонусы!</div>
    <div style="color: var(--tg-theme-accent-color, #ff3c3c); font-size: 16px; margin: 10px 0;">Твоя реферальная ссылка:</div>
    <div class="ref-link" id="ref-link">${link}</div>
    <button class="btn btn-referral" id="copy-link-btn" style="margin-top:10px;">Скопировать</button>
  `;
  document.getElementById('copy-link-btn').onclick = () => {
    navigator.clipboard.writeText(link).then(() => {
      tg.showPopup ? tg.showPopup({title: 'Скопировано!', message: 'Ссылка скопирована. Поделись с друзьями!'}) : alert('Ссылка скопирована!');
    });
  };
}

// --- Home screen shortcut ---
function addHomeScreenButton() {
  if (tg.isVersionAtLeast && tg.isVersionAtLeast('8.0') && tg.canAddToHomeScreen) {
    const btn = document.createElement('button');
    btn.className = 'btn btn-checkin';
    btn.innerText = 'Добавить на домашний экран';
    btn.style.marginTop = '20px';
    btn.onclick = () => tg.addToHomeScreen();
    document.getElementById('start-btns').appendChild(btn);
  }
}

// --- Init ---
document.addEventListener('DOMContentLoaded', function() {
  tg.ready && tg.ready();
  tg.expand && tg.expand();

  loadUserData();
  updateStreakDisplay();
  addHomeScreenButton();

  // Start screen
  document.getElementById('checkin-btn').onclick = () => {
    showScreen('checkin-screen');
    showBg('checkin-bg');
    updateStreakDisplay();
  };
  document.getElementById('referral-btn').onclick = () => {
    showScreen('referral-screen');
    showBg('referral-bg');
    showReferralInfo();
  };
  // Back buttons
  document.getElementById('back-from-checkin').onclick = () => {
    showScreen('start-screen');
    showBg('start-bg');
  };
  document.getElementById('back-from-referral').onclick = () => {
    showScreen('start-screen');
    showBg('start-bg');
  };
  // Check-in reward buttons
  document.getElementById('xp-btn').onclick = () => performCheckIn('xp');
  document.getElementById('xgo-btn').onclick = () => performCheckIn('xgo');
});

</script>
</body>
</html>
