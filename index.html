<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>XGO Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    @font-face {
      font-family: 'Brinnan';
      src: url('Brinnan-Bold.otf') format('opentype');
      font-weight: bold;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: 'Brinnan', monospace;
      background-color: #000;
    }

    .background-video {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      z-index: 0;
    }

    .screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 1;
    }

    .active {
      display: flex !important;
    }

    .btn {
      padding: 16px 40px;
      font-size: 24px;
      font-weight: bold;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-family: 'Brinnan', monospace;
      background: transparent;
      border: 2px solid #ff3c3c;
      color: white;
      box-shadow:
        0 0 10px #ff3c3c,
        0 0 20px rgba(255, 60, 60, 0.4);
      transition: all 0.3s ease;
      margin: 15px 0;
      letter-spacing: 1px;
    }

    .btn:hover, .btn:focus {
      transform: scale(1.05);
      box-shadow:
        0 0 15px #ff3c3c,
        0 0 30px rgba(255, 60, 60, 0.6);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .button-container {
      position: absolute;
      bottom: 120px;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      z-index: 5;
    }

    .title {
      font-size: 52px;
      font-weight: bold;
      color: white;
      text-shadow: 0 0 10px #ff3c3c;
      margin-bottom: 30px;
      letter-spacing: 2px;
    }

    .stats {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 40px;
    }

    .stats-label {
      font-size: 24px;
      color: white;
      margin-bottom: 5px;
    }

    .stats-value {
      font-size: 60px;
      font-weight: bold;
      color: #ff3c3c;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
    }

    .reward-badge {
      background: rgba(0, 0, 0, 0.6);
      border: 2px solid #ff3c3c;
      color: white;
      padding: 12px 24px;
      border-radius: 50px;
      font-size: 20px;
      font-weight: bold;
      margin: 10px;
      box-shadow: 0 0 10px rgba(255, 60, 60, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .rewards {
      display: flex;
      margin-bottom: 40px;
    }

    #user-info {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 16px;
      color: white;
      background: rgba(0, 0, 0, 0.6);
      padding: 8px 15px;
      border-radius: 20px;
      z-index: 10;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255, 60, 60, 0.3);
    }

    .referral-link {
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid #ff3c3c;
      padding: 15px 20px;
      border-radius: 10px;
      color: white;
      font-size: 18px;
      margin: 20px 0 40px 0;
      width: 80%;
      max-width: 320px;
      text-align: center;
      word-break: break-all;
    }

    .referral-info {
      display: flex;
      justify-content: space-around;
      width: 100%;
      max-width: 320px;
      margin-bottom: 20px;
    }

    .referral-stat {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .referral-stat-value {
      font-size: 36px;
      font-weight: bold;
      color: #ff3c3c;
    }

    .referral-stat-label {
      font-size: 16px;
      color: white;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    .hidden {
      display: none !important;
    }

    .fade-in {
      animation: fadeIn 0.5s forwards;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
</head>
<body>
  <!-- –í–∏–¥–µ–æ —Ñ–æ–Ω—ã -->
  <video muted loop playsinline autoplay class="background-video" id="start-bg">
    <source src="—Å—Ç–∏–ª—å1.mp4" type="video/mp4" />
  </video>

  <video muted loop playsinline class="background-video hidden" id="checkin-bg">
    <source src="chek-in.mp4" type="video/mp4" />
  </video>

  <video muted loop playsinline class="background-video hidden" id="referral-bg">
    <source src="referral.mp4" type="video/mp4" />
  </video>

  <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
  <div id="user-info">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

  <!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
  <div class="screen active" id="start-screen">
      <div class="button-container">
      <button class="btn" id="checkin-btn">CHECK IN</button>
      <button class="btn" id="referral-btn">REFERRAL</button>
    </div>
  </div>

  <!-- –≠–∫—Ä–∞–Ω —á–µ–∫–∏–Ω–∞ -->
  <div class="screen" id="checkin-screen">
    <div class="title">Daily Check-in</div>
    <div class="stats">
      <div class="stats-label">DAYS STREAK</div>
      <div class="stats-value" id="streak-days">0</div>
    </div>
    <div class="rewards">
      <div class="reward-badge">+10 XP</div>
      <div class="reward-badge">+5 XGO</div>
    </div>
    <div class="button-container">
      <button class="btn" id="back-from-checkin-btn">BACK</button>
    </div>
  </div>

  <!-- –≠–∫—Ä–∞–Ω —Ä–µ—Ñ–µ—Ä–∞–ª–∞ -->
  <div class="screen" id="referral-screen">
    <div class="title">Referral Program</div>
    <div class="referral-link" id="referral-link">Loading link...</div>
    <div class="referral-info">
      <div class="referral-stat">
        <div class="referral-stat-value" id="referral-count">0</div>
        <div class="referral-stat-label">Referrals</div>
      </div>
      <div class="referral-stat">
        <div class="referral-stat-value" id="referral-reward">0</div>
        <div class="referral-stat-label">XGO Earned</div>
      </div>
    </div>
    <button class="btn" id="copy-btn">COPY LINK</button>
    <div class="button-container">
      <button class="btn" id="back-from-referral-btn">BACK</button>
    </div>
  </div>

  <script type="module">
    // –ò–º–ø–æ—Ä—Ç –∫–ª—é—á–µ–π –∏–∑ supabase.js (—Å–æ–∑–¥–∞–π—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª)
    import { SUPABASE_URL, SUPABASE_KEY } from './supabase.js';
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const startScreen = document.getElementById('start-screen');
    const checkinScreen = document.getElementById('checkin-screen');
    const referralScreen = document.getElementById('referral-screen');
    const startBg = document.getElementById('start-bg');
    const checkinBg = document.getElementById('checkin-bg');
    const referralBg = document.getElementById('referral-bg');
    const userInfo = document.getElementById('user-info');
    const checkinBtn = document.getElementById('checkin-btn');
    const referralBtn = document.getElementById('referral-btn');
    const streakDaysEl = document.getElementById('streak-days');
    const referralLinkEl = document.getElementById('referral-link');
    const referralCountEl = document.getElementById('referral-count');
    const referralRewardEl = document.getElementById('referral-reward');
    const copyBtn = document.getElementById('copy-btn');
    
    // Telegram –∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const tg = window.Telegram?.WebApp;
    let telegramId = null;
    let userName = null;
    let isTestMode = false;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    async function initApp() {
      console.log("Initializing app...");
      
      // –†–∞—Å—à–∏—Ä—è–µ–º –æ–∫–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      if (tg) {
        tg.expand();
        
        // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        try {
          if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            telegramId = tg.initDataUnsafe.user.id.toString();
            userName = tg.initDataUnsafe.user.first_name || 'User';
            userInfo.innerHTML = `üë§ ${userName}`;
            console.log("User detected:", telegramId, userName);
          } else {
            console.log("No user data in initDataUnsafe");
            activateTestMode();
          }
        } catch (e) {
          console.error("Error getting Telegram user:", e);
          activateTestMode();
        }
      } else {
        console.log("Telegram WebApp not found");
        activateTestMode();
      }
      
      // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
      await loadUserData();
      
      // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏
      generateReferralLink();
      
      // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
      setupEventListeners();
    }
    
    // –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞
    function activateTestMode() {
      telegramId = 'test_user_' + Math.floor(Math.random() * 1000);
      userName = 'Test User';
      userInfo.innerHTML = `üß™ Test Mode`;
      isTestMode = true;
      console.log("Test mode activated with ID:", telegramId);
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Supabase
    async function loadUserData() {
      try {
        console.log("Loading user data for:", telegramId);
        
        let { data, error } = await supabase
          .from('user_checkins')
          .select('*')
          .eq('telegram_id', telegramId)
          .single();
        
        if (error && error.code !== 'PGRST116') {
          console.error("Database error:", error);
          return;
        }
        
        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
        if (!data) {
          console.log("Creating new user");
          const { data: newUser, error: createError } = await supabase
            .from('user_checkins')
            .insert([{
              telegram_id: telegramId,
              streak_days: 0,
              total_xp: 0,
              last_checkin: null
            }])
            .select();
          
          if (createError) {
            console.error("Error creating user:", createError);
            return;
          }
          
          data = newUser[0];
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        updateUI(data);
        
      } catch (e) {
        console.error("Error in loadUserData:", e);
      }
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function updateUI(userData) {
      if (!userData) return;
      
      console.log("Updating UI with user data:", userData);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Ä–∏—é –¥–Ω–µ–π
      streakDaysEl.textContent = userData.streak_days || 0;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ (–≤ –±—É–¥—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)
      referralCountEl.textContent = 0;
      referralRewardEl.textContent = 0;
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ —á–µ–∫–∏–Ω–∞
    async function handleCheckin() {
      try {
        console.log("Handling check-in for user:", telegramId);
        
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const { data: user, error: userError } = await supabase
          .from('user_checkins')
          .select('*')
          .eq('telegram_id', telegramId)
          .single();
        
        if (userError) {
          console.error("Error getting user for check-in:", userError);
          alert("Error performing check-in");
          return;
        }
        
        const now = new Date();
        const lastCheckin = user.last_checkin ? new Date(user.last_checkin) : null;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—à–ª–æ –ª–∏ 24 —á–∞—Å–∞ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á–µ–∫–∏–Ω–∞
        if (lastCheckin && (now - lastCheckin) < 86400000) {
          if (isTestMode) {
            console.log("Test mode: Bypassing 24h check-in limit");
          } else {
            alert("You already checked in today. Come back tomorrow!");
            return;
          }
        }
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ª–∏ —Å–µ—Ä–∏—è (–º–µ–Ω—å—à–µ 48 —á–∞—Å–æ–≤)
        const streakContinues = lastCheckin && (now - lastCheckin) < 172800000;
        const newStreak = streakContinues ? (user.streak_days || 0) + 1 : 1;
        const newXP = (user.total_xp || 0) + 10;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –±–∞–∑–µ
        const { error: updateError } = await supabase
          .from('user_checkins')
          .update({
            last_checkin: now.toISOString(),
            streak_days: newStreak,
            total_xp: newXP
          })
          .eq('telegram_id', telegramId);
        
        if (updateError) {
          console.error("Error updating check-in:", updateError);
          alert("Error saving check-in");
          return;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —á–µ–∫–∏–Ω–∞
        streakDaysEl.textContent = newStreak;
        showScreen('checkin');
        
        console.log("Check-in successful. New streak:", newStreak);
        
      } catch (e) {
        console.error("Error during check-in:", e);
        alert("An unexpected error occurred");
      }
    }
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏
    function generateReferralLink() {
      const baseUrl = window.location.origin + window.location.pathname;
      const refLink = `${baseUrl}?ref=${telegramId}`;
      referralLinkEl.textContent = refLink;
    }
    
    // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏
    function copyReferralLink() {
      const link = referralLinkEl.textContent;
      navigator.clipboard.writeText(link).then(() => {
        // –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ñ–∏–¥–±–µ–∫
        copyBtn.textContent = "COPIED!";
        setTimeout(() => {
          copyBtn.textContent = "COPY LINK";
        }, 2000);
      }).catch(err => {
        console.error("Error copying link:", err);
        alert("Could not copy link. Please copy it manually.");
      });
    }
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
    function setupEventListeners() {
      // –ö–Ω–æ–ø–∫–∞ —á–µ–∫–∏–Ω–∞
      checkinBtn.addEventListener('click', handleCheckin);
      
      // –ö–Ω–æ–ø–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã
      referralBtn.addEventListener('click', () => showScreen('referral'));
      
      // –ö–Ω–æ–ø–∫–∏ –Ω–∞–∑–∞–¥
      document.getElementById('back-from-checkin-btn').addEventListener('click', () => showScreen('start'));
      document.getElementById('back-from-referral-btn').addEventListener('click', () => showScreen('start'));
      
      // –ö–Ω–æ–ø–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏
      copyBtn.addEventListener('click', copyReferralLink);
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —ç–∫—Ä–∞–Ω–∞–º–∏
    function showScreen(screenName) {
      // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —ç–∫—Ä–∞–Ω—ã
      startScreen.classList.remove('active');
      checkinScreen.classList.remove('active');
      referralScreen.classList.remove('active');
      
      // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∏–¥–µ–æ
      startBg.classList.add('hidden');
      checkinBg.classList.add('hidden');
      referralBg.classList.add('hidden');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π —ç–∫—Ä–∞–Ω –∏ –≤–∏–¥–µ–æ
      if (screenName === 'start') {
        startScreen.classList.add('active', 'fade-in');
        startBg.classList.remove('hidden');
        startBg.play().catch(e => console.log("Video play error:", e));
      } else if (screenName === 'checkin') {
        checkinScreen.classList.add('active', 'fade-in');
        checkinBg.classList.remove('hidden');
        checkinBg.play().catch(e => console.log("Video play error:", e));
        // –ê–Ω–∏–º–∞—Ü–∏—è —á–∏—Å–ª–∞ –¥–Ω–µ–π
        streakDaysEl.classList.add('pulse');
        setTimeout(() => streakDaysEl.classList.remove('pulse'), 3000);
      } else if (screenName === 'referral') {
        referralScreen.classList.add('active', 'fade-in');
        referralBg.classList.remove('hidden');
        referralBg.play().catch(e => console.log("Video play error:", e));
      }
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä —Ä–µ—Ñ–µ—Ä–∞–ª–∞ –≤ URL
    function checkReferralParam() {
      const urlParams = new URLSearchParams(window.location.search);
      const ref = urlParams.get('ref');
      if (ref && ref !== telegramId) {
        console.log("Referred by:", ref);
        // –ó–¥–µ—Å—å –ª–æ–≥–∏–∫–∞ —É—á–µ—Ç–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∞ (–Ω–∞ –±—É–¥—É—â–µ–µ)
      }
    }
    
    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
   document.addEventListener('DOMContentLoaded', async () => {
  let tg = window.Telegram?.WebApp;
  let telegramId = null;
  let userName = null;

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
    telegramId = tg.initDataUnsafe.user.id.toString();
    userName = tg.initDataUnsafe.user.first_name || 'User';
    document.getElementById('user-info').innerHTML = `üë§ ${userName}`;
    document.getElementById('checkin-btn').disabled = false;
    document.getElementById('referral-btn').disabled = false;
  } else {
    // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö Telegram ‚Äî —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º
    telegramId = 'test_user_' + Math.floor(Math.random() * 1000);
    userName = 'Test User';
    document.getElementById('user-info').innerHTML = `üß™ Test Mode`;
    document.getElementById('checkin-btn').disabled = false;
    document.getElementById('referral-btn').disabled = false;
  }
});
  </script>
</body>
</html>
