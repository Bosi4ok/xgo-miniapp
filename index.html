<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>XGO Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    @font-face {
      font-family: 'Brinnan';
      src: url('Brinnan-Bold.otf') format('opentype');
      font-weight: bold;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: 'Brinnan', monospace;
      background-color: #000;
    }

    .background-video {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      z-index: 0;
    }

    .screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 1;
    }

    .active {
      display: flex !important;
    }

    .btn {
      padding: 12px 28px;
      font-size: 20px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-family: 'Brinnan', monospace;
      background: #000;
      border: 2px solid #ff3c3c;
      box-shadow: 0 0 4px #ff3c3c, 0 0 8px #ff3c3c;
      transition: all 0.2s ease-in-out;
      color: white;
    }

    .btn-referral {
      color: #ff3c3c;
    }

    .btn:hover {
      transform: scale(1.05);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .button-group {
      display: flex;
      gap: 40px;
      margin-top: 20px;
    }

    .button-container {
      position: absolute;
      bottom: 9%;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      gap: 20px;
    }

    .label {
      font-size: 36px;
      font-weight: bold;
      color: white;
      text-shadow: 1px 1px 0 #ff3c3c, -1px -1px 0 #ff3c3c, 2px 2px 10px #ff3c3c;
      margin-top: 54vh;
    }

    .days {
      font-size: 60px;
      font-weight: bold;
      color: #ff3c3c;
      text-shadow: 0 0 2px #ffffff, 0 0 4px #ffffff, 0 0 6px #ffffff;
      margin-top: 10px;
    }
    
    #user-info {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 14px;
      color: white;
      background: rgba(0, 0, 0, 0.5);
      padding: 5px 10px;
      border-radius: 10px;
      z-index: 10;
    }
    
    .reward-badge {
      background: #ff3c3c;
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      display: inline-flex;
      align-items: center;
      margin: 5px;
      box-shadow: 0 0 10px rgba(255, 60, 60, 0.7);
    }
    
    .reward-badge img {
      height: 20px;
      margin-right: 5px;
    }
    
    .streak-animation {
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    .hidden {
      display: none !important;
    }
    
    .fade-in {
      animation: fadeIn 0.5s forwards;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
</head>
<body>
  <!-- –í–∏–¥–µ–æ —Ñ–æ–Ω—ã -->
  <video muted loop playsinline autoplay class="background-video" id="start-bg">
    <source src="—Å—Ç–∏–ª—å1.mp4" type="video/mp4" />
  </video>

  <video muted loop playsinline class="background-video hidden" id="checkin-bg">
    <source src="chek-in.mp4" type="video/mp4" />
  </video>

  <video muted loop playsinline class="background-video hidden" id="referral-bg">
    <source src="referral.mp4" type="video/mp4" />
  </video>

  <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
  <div id="user-info">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π —ç–∫—Ä–∞–Ω -->
  <div class="screen active" id="start-screen">
    <div class="button-container">
      <button class="btn" id="checkin-btn" disabled>CHECK IN</button>
      <button class="btn btn-referral" id="referral-btn">REFERRAL</button>
    </div>
  </div>

  <!-- –≠–∫—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ–≥–æ —á–µ–∫–∏–Ω–∞ -->
  <div class="screen" id="success-screen">
    <div class="label">üéâ –ß–µ–∫–∏–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω!</div>
    <div class="days">
      <span id="streak-days">0</span> <span class="streak-text">–¥–Ω–µ–π –ø–æ–¥—Ä—è–¥</span>
    </div>
    <div class="button-group">
      <div class="reward-badge">
        <img src="xp-icon.svg" alt="XP"> +10 XP
      </div>
      <div class="reward-badge">
        <img src="xgo-icon.svg" alt="XGO"> +5 XGO
      </div>
    </div>
    <div class="button-container" style="position: relative; bottom: 0;">
      <button class="btn" id="back-btn">‚¨Ö –ù–ê–ó–ê–î</button>
    </div>
  </div>

  <!-- –≠–∫—Ä–∞–Ω —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã -->
  <div class="screen" id="referral-screen">
    <div class="label">REFERRAL PROGRAM</div>
    <div style="color: white; font-size: 24px; margin-top: 20px;">–ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π XGO</div>
    <div class="button-group" style="margin-top: 40px;">
      <button class="btn" id="copy-ref-btn">–°–ö–û–ü–ò–†–û–í–ê–¢–¨ –°–°–´–õ–ö–£</button>
    </div>
    <div style="color: white; margin-top: 20px; text-align: center;">
      <div>–¢—ã –ø—Ä–∏–≥–ª–∞—Å–∏–ª: <span id="referral-count">0</span> —á–µ–ª.</div>
      <div>–ù–∞–≥—Ä–∞–¥–∞: <span id="referral-reward">0</span> XGO</div>
    </div>
    <div class="button-container" style="position: relative; bottom: 0;">
      <button class="btn btn-referral" id="back-from-ref-btn">‚¨Ö –ù–ê–ó–ê–î</button>
    </div>
  </div>

  <script>
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Supabase - –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–∏ –∑–Ω–∞—á–µ–Ω–∏—è
    const SUPABASE_URL = 'https://msstnczyshmnhjcnzjlg.supabase.co'; // –Ω–∞–ø—Ä–∏–º–µ—Ä https://abcdefghijk.supabase.co
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1zc3RuY3p5c2htbmhqY256amxnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUzMjI0MjUsImV4cCI6MjA2MDg5ODQyNX0.9Oa_ghFyX9qVquxokvLMSNRfQq7FzA6mQEvlsM2ZyRc'; // anon/public key
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const startScreen = document.getElementById('start-screen');
    const successScreen = document.getElementById('success-screen');
    const referralScreen = document.getElementById('referral-screen');
    const startBg = document.getElementById('start-bg');
    const checkinBg = document.getElementById('checkin-bg');
    const referralBg = document.getElementById('referral-bg');
    const userInfo = document.getElementById('user-info');
    const checkinBtn = document.getElementById('checkin-btn');
    const referralBtn = document.getElementById('referral-btn');
    const streakDaysElement = document.getElementById('streak-days');
    const referralCountElement = document.getElementById('referral-count');
    const referralRewardElement = document.getElementById('referral-reward');
    
    // –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    let userData = null;
    let telegramId = null;
    let userCheckinsData = null;
    
    // –ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
    const successSound = new Audio('success.mp3'); // –¥–æ–±–∞–≤—å—Ç–µ —Ñ–∞–π–ª –∑–≤—É–∫–∞
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Mini App
    const tg = window.Telegram.WebApp;
    
    // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    async function initApp() {
      // –†–∞—Å—à–∏—Ä—è–µ–º –æ–∫–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      if (tg) {
        tg.expand();
        userData = tg.initDataUnsafe?.user;
        
        if (userData) {
          telegramId = userData.id.toString();
          userInfo.innerHTML = `üë§ ${userData.first_name || 'User'}`;
          checkinBtn.disabled = false;
          
          // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Supabase
          await getUserData();
        } else {
          userInfo.innerHTML = '‚ö†Ô∏è –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram';
        }
      } else {
        userInfo.innerHTML = '‚ö†Ô∏è Telegram –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω';
        // –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –æ—Ç–ª–∞–¥–∫–∏
        telegramId = 'test_user_123';
        checkinBtn.disabled = false;
        await getUserData();
      }
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Supabase
    async function getUserData() {
      try {
        let { data, error } = await supabase
          .from('user_checkins')
          .select('*')
          .eq('telegram_id', telegramId)
          .single();
        
        if (error && error.code !== 'PGRST116') {
          console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
          return;
        }
        
        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –≤ –±–∞–∑–µ, —Å–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å
        if (!data) {
          const { data: newUser, error: insertError } = await supabase
            .from('user_checkins')
            .insert([{
              telegram_id: telegramId,
              streak_days: 0,
              total_xp: 0
            }])
            .select();
            
          if (insertError) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', insertError);
            return;
          }
          
          userCheckinsData = newUser[0];
        } else {
          userCheckinsData = data;
        }
        
        updateUIWithUserData();
      } catch (err) {
        console.error('–ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞:', err);
      }
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function updateUIWithUserData() {
      if (userCheckinsData) {
        streakDaysElement.textContent = userCheckinsData.streak_days;
        referralCountElement.textContent = '0'; // –í –±—É–¥—É—â–µ–º - –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        referralRewardElement.textContent = '0'; // –í –±—É–¥—É—â–µ–º - –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
      }
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ —á–µ–∫–∏–Ω–∞
    async function handleCheckin() {
      if (!telegramId) return;
      
      try {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á–µ–∫–∏–Ω–∞
        if (userCheckinsData.last_checkin) {
          const lastCheckin = new Date(userCheckinsData.last_checkin);
          const now = new Date();
          const diffHours = (now - lastCheckin) / (1000 * 60 * 60);
          
          if (diffHours < 24) {
            tg?.showAlert('–í—ã —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–ª–∏ —á–µ–∫–∏–Ω —Å–µ–≥–æ–¥–Ω—è!');
            return;
          }
          
          // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±—Ä–æ—Å–∞ —Å–µ—Ä–∏–∏ (–µ—Å–ª–∏ –ø—Ä–æ—à–ª–æ –±–æ–ª–µ–µ 48 —á–∞—Å–æ–≤)
          const streakReset = diffHours > 48;
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –±–∞–∑–µ
          const { data, error } = await supabase
            .from('user_checkins')
            .update({
              last_checkin: new Date().toISOString(),
              streak_days: streakReset ? 1 : userCheckinsData.streak_days + 1,
              total_xp: userCheckinsData.total_xp + 10
            })
            .eq('telegram_id', telegramId)
            .select();
            
          if (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
            tg?.showAlert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —á–µ–∫–∏–Ω–µ.');
            return;
          }
          
          userCheckinsData = data[0];
        } else {
          // –ü–µ—Ä–≤—ã–π —á–µ–∫–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          const { data, error } = await supabase
            .from('user_checkins')
            .update({
              last_checkin: new Date().toISOString(),
              streak_days: 1,
              total_xp: 10
            })
            .eq('telegram_id', telegramId)
            .select();
            
          if (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–≤–æ–≥–æ —á–µ–∫–∏–Ω–∞:', error);
            tg?.showAlert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —á–µ–∫–∏–Ω–µ.');
            return;
          }
          
          userCheckinsData = data[0];
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —É—Å–ø–µ—Ö–∞
        updateUIWithUserData();
        showSuccessScreen();
        try {
          successSound.play();
        } catch (e) {
          console.log('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞:', e);
        }
      } catch (err) {
        console.error('–ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ —á–µ–∫–∏–Ω–∞:', err);
        tg?.showAlert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —á–µ–∫–∏–Ω–µ.');
      }
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ–≥–æ —á–µ–∫–∏–Ω–∞
    function showSuccessScreen() {
      startScreen.classList.remove('active');
      referralScreen.classList.remove('active');
      successScreen.classList.add('active', 'fade-in');
      
      startBg.classList.add('hidden');
      referralBg.classList.add('hidden');
      checkinBg.classList.remove('hidden');
      checkinBg.play().catch(e => console.log('–û—à–∏–±–∫–∞ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏—è –≤–∏–¥–µ–æ:', e));
      
      // –ê–Ω–∏–º–∞—Ü–∏—è —á–∏—Å–ª–∞ –¥–Ω–µ–π
      streakDaysElement.classList.add('streak-animation');
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã
    function showReferralScreen() {
      startScreen.classList.remove('active');
      successScreen.classList.remove('active');
      referralScreen.classList.add('active', 'fade-in');
      
      startBg.classList.add('hidden');
      checkinBg.classList.add('hidden');
      referralBg.classList.remove('hidden');
      referralBg.play().catch(e => console.log('–û—à–∏–±–∫–∞ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏—è –≤–∏–¥–µ–æ:', e));
    }
    
    // –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
    function goToMainScreen() {
      successScreen.classList.remove('active');
      referralScreen.classList.remove('active');
      startScreen.classList.add('active', 'fade-in');
      
      checkinBg.classList.add('hidden');
      referralBg.classList.add('hidden');
      startBg.classList.remove('hidden');
      streakDaysElement.classList.remove('streak-animation');
    }
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏
    function copyReferralLink() {
      const refLink = `https://t.me/xgo_mini_app?start=${telegramId}`;
      navigator.clipboard.writeText(refLink).then(() => {
        tg?.showAlert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
      }).catch(err => {
        console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
        tg?.showAlert('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏.');
      });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    document.addEventListener('DOMContentLoaded', async () => {
      await initApp();
      
      // –ö–Ω–æ–ø–∫–∞ —á–µ–∫–∏–Ω–∞
      checkinBtn.addEventListener('click', handleCheckin);
      
      // –ö–Ω–æ–ø–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã
      referralBtn.addEventListener('click', showReferralScreen);
      
      // –ö–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
      document.getElementById('back-btn').addEventListener('click', goToMainScreen);
      document.getElementById('back-from-ref-btn').addEventListener('click', goToMainScreen);
      
      // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏
      document.getElementById('copy-ref-btn').addEventListener('click', copyReferralLink);
    });
  </script>
</body>
</html>
