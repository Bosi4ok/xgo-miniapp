<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>XGO Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      background: #111;
      min-height: 100vh;
      margin: 0;
      font-family: 'Arial', monospace;
      color: #fff;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
    }
    .container {
      margin-top: 60px;
      width: 100%;
      max-width: 400px;
      background: rgba(16,16,16,0.96);
      border-radius: 18px;
      box-shadow: 0 0 32px #ff3c3c33;
      padding: 32px 18px 24px 18px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .neon-btn {
      display: inline-block;
      padding: 16px 36px;
      margin: 16px 0 0 0;
      font-size: 22px;
      font-family: inherit;
      color: #fff;
      background: transparent;
      border: 2px solid #ff3c3c;
      border-radius: 12px;
      letter-spacing: 1px;
      cursor: pointer;
      text-transform: uppercase;
      box-shadow:
        0 0 8px #ff3c3c,
        0 0 16px #ff3c3c44;
      transition: box-shadow 0.2s, color 0.2s;
    }
    .neon-btn:hover, .neon-btn:focus {
      color: #ff3c3c;
      box-shadow:
        0 0 16px #ff3c3c,
        0 0 32px #ff3c3c88;
      outline: none;
    }
    .hidden { display: none !important; }
    .big { font-size: 2.2em; font-weight: bold; margin: 24px 0 10px 0; }
    .stat { font-size: 1.25em; margin: 10px 0; }
    .success-emoji { font-size: 2em; }
    #user-info {
      position: absolute;
      top: 14px;
      right: 18px;
      font-size: 15px;
      color: #fff;
      background: rgba(0,0,0,0.32);
      padding: 4px 10px;
      border-radius: 8px;
      z-index: 10;
      letter-spacing: 0.5px;
    }
  </style>
</head>
<body>
  <div id="user-info">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  <div class="container" id="main-screen">
    <div class="big">XGO Mini App</div>
    <button class="neon-btn" id="checkin-btn" disabled>CHECK IN</button>
  </div>
  <div class="container hidden" id="success-screen">
    <div class="success-emoji">üéâ</div>
    <div class="big">–ß–µ–∫–∏–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω!</div>
    <div class="stat">–î–Ω–µ–π –ø–æ–¥—Ä—è–¥: <span id="streak-days">0</span></div>
    <div class="stat">–í—Å–µ–≥–æ XP: <span id="total-xp">0</span></div>
    <button class="neon-btn" id="back-btn">–ù–∞–∑–∞–¥</button>
  </div>
  <script type="module">
    import { SUPABASE_URL, SUPABASE_KEY } from './supabase.js';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const tg = window.Telegram?.WebApp;
    let telegramId = null;

    const userInfo = document.getElementById('user-info');
    const mainScreen = document.getElementById('main-screen');
    const successScreen = document.getElementById('success-screen');
    const checkinBtn = document.getElementById('checkin-btn');
    const backBtn = document.getElementById('back-btn');
    const streakDaysEl = document.getElementById('streak-days');
    const totalXpEl = document.getElementById('total-xp');

    async function getTelegramId() {
      if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
        telegramId = tg.initDataUnsafe.user.id.toString();
        userInfo.textContent = `üë§ ${tg.initDataUnsafe.user.first_name || ''} (${telegramId})`;
      } else {
        // –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
        telegramId = 'test_user_123';
        userInfo.textContent = `–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º (${telegramId})`;
      }
    }

    async function getUserRow() {
      const { data, error } = await supabase
        .from('user_checkins')
        .select('*')
        .eq('telegram_id', telegramId)
        .single();
      if (error && error.code !== 'PGRST116') {
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
        return null;
      }
      return data || null;
    }

    async function createUserRow() {
      const { data, error } = await supabase
        .from('user_checkins')
        .insert([{
          telegram_id: telegramId,
          streak_days: 0,
          total_xp: 0
        }])
        .select();
      if (error) {
        alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + error.message);
        return null;
      }
      return data[0];
    }

    async function handleCheckin() {
      let user = await getUserRow();
      const now = new Date();

      if (!user) {
        user = await createUserRow();
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á–µ–∫–∏–Ω–∞
      const lastCheckin = user.last_checkin ? new Date(user.last_checkin) : null;
      const diff = lastCheckin ? now - lastCheckin : Infinity;

      if (diff < 86400000) {
        alert('–ß–µ–∫–∏–Ω —É–∂–µ –±—ã–ª —Å–µ–≥–æ–¥–Ω—è!');
        return;
      }

      // streak_days: +1 –µ—Å–ª–∏ —á–µ–∫–∏–Ω <48—á, –∏–Ω–∞—á–µ 1
      const newStreak = (diff < 2 * 86400000) ? (user.streak_days || 0) + 1 : 1;
      const newXP = (user.total_xp || 0) + 10;

      const { data, error } = await supabase
        .from('user_checkins')
        .update({
          last_checkin: now.toISOString(),
          streak_days: newStreak,
          total_xp: newXP
        })
        .eq('telegram_id', telegramId)
        .select();

      if (error) {
        alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + error.message);
        return;
      }

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
      streakDaysEl.textContent = newStreak;
      totalXpEl.textContent = newXP;
      mainScreen.classList.add('hidden');
      successScreen.classList.remove('hidden');
    }

    checkinBtn.onclick = handleCheckin;
    backBtn.onclick = () => {
      successScreen.classList.add('hidden');
      mainScreen.classList.remove('hidden');
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    (async function init() {
      await getTelegramId();
      checkinBtn.disabled = false;
    })();
  </script>
</body>
</html>
