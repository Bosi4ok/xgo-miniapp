<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Check-In Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      background-color: black;
      color: white;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      gap: 20px;
    }
    button {
      padding: 12px 24px;
      font-size: 18px;
      font-weight: bold;
      background: #000;
      border: 2px solid #ff3c3c;
      color: #fff;
      border-radius: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Check-In</h1>
  <div>Active days: <span id="streak">-</span></div>
  <button id="checkin-btn">Check In</button>

  <script>
    const SUPABASE_URL = 'https://wtwjgyvaeggutjahhysp.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind0d2pneXZhZWdndXRqYWhoeXNwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ4MDIxODksImV4cCI6MjA2MDM3ODE4OX0.m58eY3O4wcK9qdSTKXf83kuImpGnQ6ro8Gw2KTCdA9Q';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
    const streakDisplay = document.getElementById("streak");

    if (!tgUser) {
      alert("❌ Не удалось определить пользователя Telegram.");
    }

    async function loadStreak() {
      const { data: user, error } = await supabase
        .from("users")
        .select("checkin_streak")
        .eq("id", tgUser.id)
        .single();
      if (user) {
        streakDisplay.innerText = user.checkin_streak;
      } else {
        streakDisplay.innerText = 0;
      }
    }

    async function handleCheckIn() {
      const today = new Date().toISOString().slice(0, 10);
      const { data: user } = await supabase.from("users").select("*").eq("id", tgUser.id).single();

      if (!user) {
        await supabase.from("users").insert([{
          id: tgUser.id,
          username: tgUser.username,
          first_name: tgUser.first_name,
          last_checkin: today,
          checkin_streak: 1,
          xp: 10,
          xgo: 0
        }]);
        streakDisplay.innerText = 1;
        alert("✅ Первый чек-ин! +10 XP");
        return;
      }

      if (user.last_checkin === today) {
        alert("⚠️ Уже чекался сегодня!");
        return;
      }

      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      const ystr = yesterday.toISOString().slice(0, 10);
      const newStreak = user.last_checkin === ystr ? user.checkin_streak + 1 : 1;

      await supabase.from("users").update({
        last_checkin: today,
        checkin_streak: newStreak,
        xp: user.xp + 10
      }).eq("id", tgUser.id);

      streakDisplay.innerText = newStreak;
      alert("✅ Чек-ин выполнен! +10 XP");
    }

    document.getElementById("checkin-btn").addEventListener("click", handleCheckIn);

    loadStreak();
  </script>
</body>
</html>
