<!DOCTYPE html>
<html lang="ru">
<head>
  ...–≤–∞—à–∏ —Ç–µ–∫—É—â–∏–µ —Å—Ç–∏–ª–∏...
  <script type="module">
    import { supabase } from './supabase.js'
    
    const tg = window.Telegram.WebApp
    let userData = null

    document.addEventListener('DOMContentLoaded', async () => {
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
      tg.expand()
      tg.ready()
      
      // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      userData = tg.initDataUnsafe?.user
      if (!userData) {
        alert('–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram!')
        return
      }
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
      await initUser()
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
      updateUI()
    })

    async function initUser() {
      const { error } = await supabase
        .from('user_checkins')
        .upsert(
          { telegram_id: userData.id.toString() },
          { onConflict: 'telegram_id' }
        )
      
      if (error) console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error)
    }

    async function handleCheckin() {
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á–µ–∫–∏–Ω–∞
      const { data } = await supabase
        .from('user_checkins')
        .select('last_checkin')
        .eq('telegram_id', userData.id.toString())
      
      const lastCheckin = new Date(data[0].last_checkin)
      const now = new Date()
      
      if ((now - lastCheckin) < 86400000) {
        tg.showAlert('–í—ã —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–ª–∏ —á–µ–∫–∏–Ω —Å–µ–≥–æ–¥–Ω—è!')
        return
      }
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
      const { data: updated, error } = await supabase
        .rpc('update_checkin', {
          user_id: userData.id.toString(),
          xp_increment: 10
        })
      
      if (error) {
        tg.showAlert('–û—à–∏–±–∫–∞: ' + error.message)
        return
      }
      
      // –ü–æ–∫–∞–∑ —ç–∫—Ä–∞–Ω–∞ —É—Å–ø–µ—Ö–∞
      showSuccessScreen(updated)
    }

    function updateUI() {
      document.getElementById('user-name').textContent = userData.first_name
      document.getElementById('user-id').textContent = userData.id
    }

    function showSuccessScreen(data) {
      // –í–∞—à–∞ –ª–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ —ç–∫—Ä–∞–Ω —É—Å–ø–µ—Ö–∞
      document.getElementById('streak-days').textContent = data.streak_days
      document.getElementById('total-xp').textContent = data.total_xp
      document.getElementById('main-screen').classList.add('hidden')
      document.getElementById('success-screen').classList.remove('hidden')
    }
  </script>
</head>
<body>
  <div id="main-screen">
    <!-- –í–∞—à —Ç–µ–∫—É—â–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
    <button onclick="handleCheckin()">CHECK IN</button>
  </div>

  <div id="success-screen" class="hidden">
    <h2>üéâ –ß–µ–∫–∏–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω!</h2>
    <p>–î–Ω–µ–π –ø–æ–¥—Ä—è–¥: <span id="streak-days">0</span></p>
    <p>–í—Å–µ–≥–æ XP: <span id="total-xp">0</span></p>
    <button onclick="location.reload()">–ù–∞–∑–∞–¥</button>
  </div>
</body>
</html>
