// u0421u043au0440u0438u043fu0442 u0434u043bu044f u0433u0430u0440u0430u043du0442u0438u0440u043eu0432u0430u043du043du043eu0433u043e u043eu0431u043du043eu0432u043bu0435u043du0438u044f u0438u043cu0435u043du0438 u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f u0432 u043cu043eu0434u0430u043bu044cu043du043eu043c u043eu043au043du0435 u043fu0440u043eu0444u0438u043bu044f

// u0424u0443u043du043au0446u0438u044f u0434u043bu044f u043fu043eu043bu0443u0447u0435u043du0438u044f ID u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f Telegram
async function getTelegramUserIdFromWebApp() {
  try {
    if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe?.user) {
      const userId = window.Telegram.WebApp.initDataUnsafe.user.id.toString();
      console.log('u041fu043eu043bu0443u0447u0435u043d Telegram ID u0438u0437 WebApp:', userId);
      return userId;
    }
  } catch (error) {
    console.error('u041eu0448u0438u0431u043au0430 u043fu0440u0438 u043fu043eu043bu0443u0447u0435u043du0438u0438 Telegram ID:', error);
  }
  return null;
}

// u0424u0443u043du043au0446u0438u044f u0434u043bu044f u043eu0431u043du043eu0432u043bu0435u043du0438u044f u0438u043cu0435u043du0438 u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f u0432 u043cu043eu0434u0430u043bu044cu043du043eu043c u043eu043au043du0435 u043fu0440u043eu0444u0438u043bu044f
async function updateProfileName() {
  // u041fu043eu043bu0443u0447u0430u0435u043c u044du043bu0435u043cu0435u043du0442 u0441 u0438u043cu0435u043du0435u043c u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f u0432 u043cu043eu0434u0430u043bu044cu043du043eu043c u043eu043au043du0435
  const userNameModal = document.getElementById('user-name-modal');
  if (!userNameModal) {
    console.error('u042du043bu0435u043cu0435u043du0442 u0441 u0438u043cu0435u043du0435u043c u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f u0432 u043cu043eu0434u0430u043bu044cu043du043eu043c u043eu043au043du0435 u043du0435 u043du0430u0439u0434u0435u043d');
    return;
  }
  
  // u041fu043eu043bu0443u0447u0430u0435u043c ID u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f Telegram
  const telegramId = await getTelegramUserIdFromWebApp();
  
  if (telegramId) {
    // u0415u0441u043bu0438 ID u043fu043eu043bu0443u0447u0435u043d, u0438u0441u043fu043eu043bu044cu0437u0443u0435u043c u0435u0433u043e u0434u043bu044f u043fu043eu043bu0443u0447u0435u043du0438u044f u0438u043cu0435u043du0438 u0438u0437 localStorage
    const savedName = localStorage.getItem('telegram_user_name_' + telegramId);
    if (savedName) {
      userNameModal.textContent = savedName;
      console.log('u0418u043cu044f u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f u043eu0431u043du043eu0432u043bu0435u043du043e u0432 u043cu043eu0434u0430u043bu044cu043du043eu043c u043eu043au043du0435 u043fu0440u043eu0444u0438u043bu044f u043fu043e ID:', savedName);
      return;
    }
    
    // u041fu0440u043eu0432u0435u0440u044fu0435u043c u043eu0431u0449u0438u0439 u043au043bu044eu0447 localStorage u0434u043bu044f u043eu0431u0440u0430u0442u043du043eu0439 u0441u043eu0432u043cu0435u0441u0442u0438u043cu043eu0441u0442u0438
    const legacyName = localStorage.getItem('telegram_user_name');
    if (legacyName) {
      userNameModal.textContent = legacyName;
      console.log('u0418u043cu044f u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f u043eu0431u043du043eu0432u043bu0435u043du043e u0438u0437 u043eu0431u0449u0435u0433u043e u043au043bu044eu0447u0430 localStorage:', legacyName);
      
      // u0421u043eu0445u0440u0430u043du044fu0435u043c u0438u043cu044f u0432 localStorage u0441 ID u0434u043bu044f u0431u0443u0434u0443u0449u0438u0445 u0441u0435u0441u0441u0438u0439
      localStorage.setItem('telegram_user_name_' + telegramId, legacyName);
      return;
    }
    
    // u0415u0441u043bu0438 u0438u043cu044f u043du0435 u043du0430u0439u0434u0435u043du043e u043du0438u0433u0434u0435, u0441u043eu0437u0434u0430u0435u043c u0438u043cu044f u043du0430 u043eu0441u043du043eu0432u0435 ID
    const defaultName = 'User_' + telegramId.substring(0, 4);
    userNameModal.textContent = defaultName;
    console.log('u0418u043cu044f u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f u0443u0441u0442u0430u043du043eu0432u043bu0435u043du043e u043fu043e u0443u043cu043eu043bu0447u0430u043du0438u044e u0432 u043cu043eu0434u0430u043bu044cu043du043eu043c u043eu043au043du0435 u043fu0440u043eu0444u0438u043bu044f:', defaultName);
    
    // u0421u043eu0445u0440u0430u043du044fu0435u043c u0438u043cu044f u0432 localStorage u0434u043bu044f u0431u0443u0434u0443u0449u0438u0445 u0441u0435u0441u0441u0438u0439
    localStorage.setItem('telegram_user_name_' + telegramId, defaultName);
    localStorage.setItem('telegram_user_name', defaultName); // u0414u043bu044f u043eu0431u0440u0430u0442u043du043eu0439 u0441u043eu0432u043cu0435u0441u0442u0438u043cu043eu0441u0442u0438
  } else {
    // u0415u0441u043bu0438 ID u043du0435 u043fu043eu043bu0443u0447u0435u043d, u0438u0441u043fu043eu043bu044cu0437u0443u0435u043c u043eu0431u0449u0438u0439 u043au043bu044eu0447 localStorage
    const savedName = localStorage.getItem('telegram_user_name');
    if (savedName) {
      userNameModal.textContent = savedName;
      console.log('u0418u043cu044f u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f u043eu0431u043du043eu0432u043bu0435u043du043e u0432 u043cu043eu0434u0430u043bu044cu043du043eu043c u043eu043au043du0435 u043fu0440u043eu0444u0438u043bu044f u0438u0437 u043eu0431u0449u0435u0433u043e localStorage:', savedName);
    } else {
      // u0415u0441u043bu0438 u0438u043cu044f u043du0435 u043du0430u0439u0434u0435u043du043e u0432 localStorage, u0438u0441u043fu043eu043bu044cu0437u0443u0435u043c u0438u043cu044f u043fu043e u0443u043cu043eu043bu0447u0430u043du0438u044e
      const defaultName = 'u0413u043eu0441u0442u044c';
      userNameModal.textContent = defaultName;
      console.log('u0418u043cu044f u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f u0443u0441u0442u0430u043du043eu0432u043bu0435u043du043e u043fu043e u0443u043cu043eu043bu0447u0430u043du0438u044e u0432 u043cu043eu0434u0430u043bu044cu043du043eu043c u043eu043au043du0435 u043fu0440u043eu0444u0438u043bu044f:', defaultName);
      
      // u0421u043eu0445u0440u0430u043du044fu0435u043c u0438u043cu044f u0432 localStorage u0434u043bu044f u0431u0443u0434u0443u0449u0438u0445 u0441u0435u0441u0441u0438u0439
      localStorage.setItem('telegram_user_name', defaultName);
    }
  }
}

// u0414u043eu0431u0430u0432u043bu044fu0435u043c u043eu0431u0440u0430u0431u043eu0442u0447u0438u043a u0441u043eu0431u044bu0442u0438u044f u0434u043bu044f u043eu0431u043du043eu0432u043bu0435u043du0438u044f u0438u043cu0435u043du0438 u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f u043fu0440u0438 u0437u0430u0433u0440u0443u0437u043au0435 u0441u0442u0440u0430u043du0438u0446u044b
document.addEventListener('DOMContentLoaded', function() {
  // u041eu0431u043du043eu0432u043bu044fu0435u043c u0438u043cu044f u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f u043fu0440u0438 u0437u0430u0433u0440u0443u0437u043au0435 u0441u0442u0440u0430u043du0438u0446u044b
  updateProfileName();
  
  // u0414u043eu0431u0430u0432u043bu044fu0435u043c u043eu0431u0440u0430u0431u043eu0442u0447u0438u043a u0441u043eu0431u044bu0442u0438u044f u0434u043bu044f u043eu0431u043du043eu0432u043bu0435u043du0438u044f u0438u043cu0435u043du0438 u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f u043fu0440u0438 u043au0430u0436u0434u043eu043c u043eu0442u043au0440u044bu0442u0438u0438 u043cu043eu0434u0430u043bu044cu043du043eu0433u043e u043eu043au043du0430 u043fu0440u043eu0444u0438u043bu044f
  const profileButton = document.querySelector('.nav-item[onclick*="profile-modal"]');
  if (profileButton) {
    profileButton.addEventListener('click', function() {
      // u041eu0431u043du043eu0432u043bu044fu0435u043c u0438u043cu044f u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f u0441 u043du0435u0431u043eu043bu044cu0448u043eu0439 u0437u0430u0434u0435u0440u0436u043au043eu0439, u0447u0442u043eu0431u044b u0433u0430u0440u0430u043du0442u0438u0440u043eu0432u0430u0442u044c, u0447u0442u043e u043cu043eu0434u0430u043bu044cu043du043eu0435 u043eu043au043du043e u0443u0436u0435 u043eu0442u043au0440u044bu0442u043e
      setTimeout(updateProfileName, 100);
    });
  }
  
  // u0414u043eu0431u0430u0432u043bu044fu0435u043c u043fu0435u0440u0438u043eu0434u0438u0447u0435u0441u043au043eu0435 u043eu0431u043du043eu0432u043bu0435u043du0438u0435 u0438u043cu0435u043du0438 u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f u0432 u043cu043eu0434u0430u043bu044cu043du043eu043c u043eu043au043du0435 u043fu0440u043eu0444u0438u043bu044f
  setInterval(function() {
    const profileModal = document.getElementById('profile-modal');
    if (profileModal && profileModal.style.display === 'block') {
      updateProfileName();
    }
  }, 1000); // u041eu0431u043du043eu0432u043bu044fu0435u043c u043au0430u0436u0434u0443u044e u0441u0435u043au0443u043du0434u0443, u0435u0441u043bu0438 u043cu043eu0434u0430u043bu044cu043du043eu0435 u043eu043au043du043e u043eu0442u043au0440u044bu0442u043e
});

// u0414u043eu0431u0430u0432u043bu044fu0435u043c u043eu0431u0440u0430u0431u043eu0442u0447u0438u043a u0441u043eu0431u044bu0442u0438u044f u0434u043bu044f u043eu0431u043du043eu0432u043bu0435u043du0438u044f u0438u043cu0435u043du0438 u043fu043eu043bu044cu0437u043eu0432u0430u0442u0435u043bu044f u043fu0440u0438 u0438u0437u043cu0435u043du0435u043du0438u0438 localStorage
window.addEventListener('storage', function(event) {
  // u041eu0431u0440u0430u0431u0430u0442u044bu0432u0430u0435u043c u0438u0437u043cu0435u043du0435u043du0438u044f u043au0430u043a u0432 u043eu0431u0449u0435u043c u043au043bu044eu0447u0435, u0442u0430u043a u0438 u0432 u043au043bu044eu0447u0430u0445 u0441 ID
  if (event.key === 'telegram_user_name' || event.key.startsWith('telegram_user_name_')) {
    updateProfileName();
  }
});
